#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Keypad.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1 
#define SCREEN_ADDRESS 0x3C 

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// --- KEYPAD CONFIGURATION ---
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
  {'1', '2', '3', 'A'},
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'},
  {'*', '0', '#', 'D'}
};

// Double-check these physical pins on your Arduino Uno
byte rowPins[ROWS] = {9, 8, 7, 6}; 
byte colPins[COLS] = {5, 10, 3, 2}; 

Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// --- GAME VARIABLES ---
char board[3][3];
char currentPlayer;
int moves;
bool gameOver;

void setup() {
  Serial.begin(9600);
  if(!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
    for(;;); 
  }
  resetGame();
}

void loop() {
  char key = keypad.getKey();

  if (key) {
    // Global Reset Button (D)
    if (key == 'D') {
      resetGame();
      return;
    }

    if (!gameOver) {
      handleInput(key);
    } else {
      resetGame(); // Press any other key to restart after game ends
    }
  }
}

void handleInput(char key) {
  int r = -1, c = -1;
  // Map 1-9 to array indices
  if (key >= '1' && key <= '9') {
    int num = key - '1'; 
    r = num / 3;
    c = num % 3;
  } else {
    return; // Ignore A, B, C, *, 0, #
  }

  if (board[r][c] == ' ') {
    board[r][c] = currentPlayer;
    moves++;
    
    if (checkWin()) {
      drawBoard();
      displayWinner(currentPlayer);
      gameOver = true;
    } else if (moves >= 9) {
      drawBoard();
      displayWinner('T'); 
      gameOver = true;
    } else {
      currentPlayer = (currentPlayer == 'X') ? 'O' : 'X';
      drawBoard();
    }
  }
}

void resetGame() {
  for(int i=0; i<3; i++) {
    for(int j=0; j<3; j++) board[i][j] = ' ';
  }
  currentPlayer = 'X';
  moves = 0;
  gameOver = false;
  drawBoard();
}

void drawBoard() {
  display.clearDisplay();
  
  // --- UI Layout (Yellow vs Blue) ---
  // Yellow Header (Top 16 pixels)
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  if (!gameOver) {
    display.print("TURN: "); display.print(currentPlayer);
    display.setCursor(80, 0); display.print("RESET:[D]");
  } else {
    display.print("GAME OVER!");
  }

  // Blue Game Area (The Grid)
  // Shifted grid down to Y=18 to clear the "yellow streak"
  display.drawFastVLine(42, 18, 46, SSD1306_WHITE);
  display.drawFastVLine(84, 18, 46, SSD1306_WHITE);
  display.drawFastHLine(0, 33, 128, SSD1306_WHITE);
  display.drawFastHLine(0, 49, 128, SSD1306_WHITE);

  for(int i=0; i<3; i++) {
    for(int j=0; j<3; j++) {
      int x = j * 42 + 15;
      int y = i * 16 + 20; 
      if(board[i][j] != ' ') {
        display.setCursor(x, y);
        display.setTextSize(2);
        display.print(board[i][j]);
      }
    }
  }
  display.display();
}

void displayWinner(char winner) {
  // Briefly overlay the result on the bottom blue section
  display.fillRect(0, 18, 128, 46, SSD1306_BLACK); 
  display.setTextSize(2);
  display.setCursor(20, 30);
  if (winner == 'T') display.print(" DRAW!");
  else {
    display.print("WINNER: "); display.print(winner);
  }
  display.display();
}

bool checkWin() {
  for(int i=0; i<3; i++) {
    if(board[i][0] != ' ' && board[i][0] == board[i][1] && board[i][1] == board[i][2]) return true;
    if(board[0][i] != ' ' && board[0][i] == board[1][i] && board[1][i] == board[2][i]) return true;
  }
  if(board[0][0] != ' ' && board[0][0] == board[1][1] && board[1][1] == board[2][2]) return true;
  if(board[0][2] != ' ' && board[0][2] == board[1][1] && board[1][1] == board[2][0]) return true;
  return false;
}
